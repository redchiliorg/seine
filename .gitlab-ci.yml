stages:
  - publish

publish:
  only: [master]
  stage: publish
  image: node:10-alpine
  cache:
    key: "$CI_JOB_STAGE"
    paths:
      - /var/cache/apk/
      - .yarn-cache/
  artifacts:
    name: "$CI_COMMIT_SHORT_SHA"
    paths: [yarn-error.log]
  before_script:
    - apk update
    - apk upgrade
    - apk add git
    - yarn
    - yarn config set cache-folder .yarn-cache
    - npm set //registry.npmjs.org/:_authToken "$NPM_TOKEN"
  script:
    - yarn workspaces run publish --non-interactive --access public --patch --no-commit-hooks --no-git-tag-version
  after_script:
    - npm config delete //registry.npmjs.org/:_authToken
    - yarn logout
